import numpy as np
import cv2  # opencv: https://pypi.python.org/pypi/opencv-python


def read_data(filename, is_RGB, visualize=False, save=False, save_name=None):
    # read the text data file
    #   data, image = read_data(filename, is_RGB) read the data file named
    #   filename. Return the data matrix with same shape as data in the file.
    #   If is_RGB is False, the data will be regarded as Lab and convert to
    #   RGB format to visualise and save.
    #
    #   data, image = read_data(filename, is_RGB, visualize)
    #   If visualize is True, the data will be shown. Default value is False.
    #
    #   data, image = read_data(filename, is_RGB, visualize, save)
    #   If save is True, the image will be saved in an jpg image with same name
    #   as the text filename. Default value is False.
    #
    #   data, image = read_data(filename, is_RGB, visualize, save, save_name)
    #   The image filename.
    #
    #   Example: data, image = read_data("1_noise.txt", True)
    #   Example: data, image = read_data("cow.txt", False, True, True, "segmented_cow.jpg")

    with open(filename, "r") as f:
        lines = f.readlines()

    data = []

    for line in lines:
        data.append(list(map(float, line.split(" "))))

    data = np.asarray(data).astype(np.float32)

    N, D = data.shape

    cols = int(data[-1, 0] + 1)
    rows = int(data[-1, 1] + 1)
    channels = D - 2
    img_data = data[:, 2:]

    # In numpy, transforming 1d array to 2d is in row-major order, which is different from the way image data is organized.
    image = np.reshape(img_data, [cols, rows, channels]).transpose((1, 0, 2))

    if visualize:
        if channels == 1:
            # for visualizing grayscale image
            cv2.imshow("", image)
        else:
            # for visualizing RGB image
            cv2.imshow("", cv2.cvtColor(image, cv2.COLOR_Lab2BGR))
        cv2.waitKey(0)
        cv2.destroyAllWindows()

    if save:
        if save_name is None:
            save_name = filename[:-4] + ".jpg"
        assert save_name.endswith(".jpg") or save_name.endswith(".png"), "Please specify the file type in suffix in 'save_name'!"

        if channels == 1:
            # for saving grayscale image
            cv2.imwrite(save_name, image)
        else:
            # for saving RGB image
            cv2.imwrite(save_name, (cv2.cvtColor(image, cv2.COLOR_Lab2BGR) * 255).astype(np.uint8))

    if not is_RGB:
        image = cv2.cvtColor(image, cv2.COLOR_Lab2RGB)

    return data, image


def write_data(data, filename):
    # write the matrix into a text file
    #   write_data(data, filename) write 2d matrix data into a text file named
    #   filename.
    #
    #   Example: write_data(data, "cow.txt")

    lines = []
    for i in range(len(data)):
        lines.append(" ".join([str(int(data[i, 0])), str(int(data[i, 1]))] + ["%.6f" % v for v in data[i, 2:]]) + "\n")

    with open(filename, "w") as f:
        f.writelines(lines)
